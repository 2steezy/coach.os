Import React, { useState, useEffect, useMemo } from 'react';
import { 
  Activity, 
  Battery, 
  ChevronRight, 
  Dumbbell, 
  Flame, 
  LayoutDashboard, 
  User, 
  Utensils, 
  Zap,
  AlertTriangle,
  CheckCircle2,
  Circle,
  X,
  Plus,
  Settings,
  Droplets,
  Clock
} from 'lucide-react';

// --- SUB-COMPONENTS DEFINED OUTSIDE TO PREVENT RE-RENDER FOCUS LOSS ---

const ProfileModal = ({ show, onClose, stats, setStats }) => {
  if (!show) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-neutral-900 w-full max-w-sm rounded-2xl border border-neutral-700 shadow-2xl overflow-hidden">
        <div className="p-4 border-b border-neutral-800 flex justify-between items-center bg-neutral-800">
          <h3 className="font-bold text-white flex items-center"><User className="w-5 h-5 mr-2 text-red-500"/> Operator Profile</h3>
          <button onClick={onClose}><X className="w-6 h-6 text-neutral-400" /></button>
        </div>
        <div className="p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-[10px] uppercase text-neutral-500 font-bold">Weight (lbs)</label>
              <input type="number" value={stats.weight} onChange={(e) => setStats({...stats, weight: e.target.value})} className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white font-mono focus:border-red-500 outline-none" />
            </div>
            <div>
              <label className="text-[10px] uppercase text-neutral-500 font-bold">Squat (lbs)</label>
              <input type="number" value={stats.squat} onChange={(e) => setStats({...stats, squat: e.target.value})} className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white font-mono focus:border-red-500 outline-none" />
            </div>
            <div>
              <label className="text-[10px] uppercase text-neutral-500 font-bold">Speed (40yd)</label>
              <input type="number" value={stats.speed} onChange={(e) => setStats({...stats, speed: e.target.value})} className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white font-mono focus:border-red-500 outline-none" />
            </div>
            <div>
              <label className="text-[10px] uppercase text-neutral-500 font-bold">Vert (in)</label>
              <input type="number" value={stats.vertical} onChange={(e) => setStats({...stats, vertical: e.target.value})} className="w-full bg-neutral-950 border border-neutral-700 rounded p-2 text-white font-mono focus:border-red-500 outline-none" />
            </div>
          </div>
          <div>
            <label className="text-[10px] uppercase text-neutral-500 font-bold mb-1 block">Injury Status: Ankle</label>
            <input type="text" value={stats.injuries.ankle} onChange={(e) => setStats({...stats, injuries: {...stats.injuries, ankle: e.target.value}})} className="w-full bg-neutral-950 border border-red-900/50 rounded p-2 text-red-200 text-xs focus:border-red-500 outline-none" />
          </div>
          <div>
            <label className="text-[10px] uppercase text-neutral-500 font-bold mb-1 block">Injury Status: Hip</label>
            <input type="text" value={stats.injuries.hip} onChange={(e) => setStats({...stats, injuries: {...stats.injuries, hip: e.target.value}})} className="w-full bg-neutral-950 border border-red-900/50 rounded p-2 text-red-200 text-xs focus:border-red-500 outline-none" />
          </div>
          <button onClick={onClose} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-2">SAVE CONFIG</button>
        </div>
      </div>
    </div>
  );
};

const AddRecipeModal = ({ show, onClose, onAdd }) => {
  const [form, setForm] = useState({ title: '', type: 'Breakfast', calories: '', ingredients: '' });

  if (!show) return null;

  const handleSubmit = () => {
    onAdd(form);
    setForm({ title: '', type: 'Breakfast', calories: '', ingredients: '' });
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-neutral-900 w-full max-w-sm rounded-2xl border border-neutral-700 shadow-2xl overflow-hidden animate-in slide-in-from-bottom-10">
        <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
          <h3 className="font-bold text-white">Add New Fuel</h3>
          <button onClick={onClose}><X className="w-5 h-5 text-neutral-400" /></button>
        </div>
        <div className="p-4 space-y-3">
          <input placeholder="Recipe Name" value={form.title} onChange={(e) => setForm({...form, title: e.target.value})} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-red-500 outline-none" />
          <div className="flex gap-2">
            <select value={form.type} onChange={(e) => setForm({...form, type: e.target.value})} className="bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 outline-none flex-1">
              <option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Shake</option><option>Snack</option>
            </select>
            <input placeholder="Cals" type="number" value={form.calories} onChange={(e) => setForm({...form, calories: e.target.value})} className="w-24 bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 outline-none" />
          </div>
          <textarea placeholder="Ingredients (comma separated)" value={form.ingredients} onChange={(e) => setForm({...form, ingredients: e.target.value})} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 h-24 outline-none resize-none"></textarea>
          <button onClick={handleSubmit} className="w-full bg-white text-black font-bold py-3 rounded-lg">ADD TO DATABASE</button>
        </div>
      </div>
    </div>
  );
};

const TechDetailModal = ({ tech, onClose }) => {
  if (!tech) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-700 shadow-2xl overflow-hidden animate-in slide-in-from-bottom-10 duration-300">
        <div className="p-5 border-b border-neutral-800 flex justify-between items-start">
          <div>
            <h3 className="text-xl font-black text-white uppercase italic">{tech.name}</h3>
            <p className="text-xs text-neutral-400 mt-1">Tech Specification Card</p>
          </div>
          <button onClick={onClose} className="p-1 hover:bg-neutral-800 rounded-full">
            <X className="w-6 h-6 text-neutral-400" />
          </button>
        </div>
        
        <div className="p-6 space-y-6">
          <div>
            <div className="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-2">Primary Cues</div>
            <p className="text-neutral-200 text-sm leading-relaxed border-l-2 border-blue-500 pl-3">
              "{tech.cues}"
            </p>
          </div>

          {tech.alerts && tech.alerts.length > 0 && (
            <div>
               <div className="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-2 flex items-center">
                 <AlertTriangle className="w-3 h-3 mr-1" /> Injury Override
               </div>
               <div className="space-y-3">
                 {tech.alerts.map((alert, i) => (
                   <div key={i} className="bg-red-900/10 border border-red-900/30 p-3 rounded-lg">
                     <span className="text-red-400 font-bold text-xs block mb-1">{alert.type}</span>
                     <span className="text-neutral-300 text-xs">{alert.msg}</span>
                   </div>
                 ))}
               </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- MAIN COMPONENT ---

const CoachOS = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedDay, setSelectedDay] = useState('Monday');
  const [selectedTech, setSelectedTech] = useState(null);
  const [showProfile, setShowProfile] = useState(false);
  const [showAddRecipe, setShowAddRecipe] = useState(false);
  const [currentPhase, setCurrentPhase] = useState(1);
  const [activeRecipeFilter, setActiveRecipeFilter] = useState('All');
  
  // User Stats State
  const [stats, setStats] = useState({
    weight: 138,
    squat: 310,
    speed: 4.8,
    vertical: 30,
    injuries: {
      ankle: "Right Ankle (Loose Tendon)",
      hip: "Left Hip (Impingement)"
    }
  });

  // Checklist State - Refactored to Timing
  const [fuelLog, setFuelLog] = useState({
    water: 0, // cups/bottles
    items: {
      morningHydration: false,
      breakfast: false,
      creatine: false,
      lunch: false,
      tendonShot: false,
      preWorkoutCarb: false,
      postWorkoutMeal: false,
      postWorkoutShake: false,
      dinner: false,
      nightShake: false
    }
  });

  // --- DATA: PHASES ---
  const phases = useMemo(() => ({
    1: {
      name: "Phase 1: Engine Building",
      weeks: "Weeks 1-4",
      focus: "Hypertrophy & Tissue Capacity",
      workouts: {
        Monday: { title: "Accel & Squat", focus: "Force", exercises: [
          { name: "Broad Jumps", sets: "3x3", completed: false },
          { name: "10m Starts", sets: "5 reps", completed: false },
          { name: "Back Squat", sets: "4x6", completed: false },
          { name: "Bulgarian Split Squats", sets: "3x8/leg", completed: false },
          { name: "Weighted Planks", sets: "3x30s", completed: false }
        ]},
        Tuesday: { title: "Upper & Ankle Armor", focus: "Mass/Tendon", exercises: [
          { name: "Bench Press", sets: "4x8", completed: false },
          { name: "Weighted Pull-Ups", sets: "4x6", completed: false },
          { name: "Iso-Lunge Holds", sets: "3x45s/side", completed: false },
          { name: "Tibialis Raises", sets: "3x15", completed: false }
        ]},
        Wednesday: { title: "Active Recovery", focus: "Mobility", exercises: [
          { name: "Light Bike/Pool", sets: "20 min", completed: false },
          { name: "World's Greatest Stretch", sets: "10 min", completed: false },
          { name: "Mock Dunk Approaches", sets: "10 reps", completed: false }
        ]},
        Thursday: { title: "Max Velocity", focus: "Speed", exercises: [
          { name: "Pogo Hops", sets: "3x10s", completed: false },
          { name: "Flying 10s", sets: "4 reps", completed: false },
          { name: "Trap Bar Deadlift", sets: "3x6", completed: false },
          { name: "Single Leg RDL", sets: "3x8/leg", completed: false }
        ]},
        Friday: { title: "Upper & Power", focus: "Elasticity", exercises: [
          { name: "Overhead Press", sets: "4x8", completed: false },
          { name: "Seated Box Jumps", sets: "3x5", completed: false },
          { name: "Lateral Lunges", sets: "3x8/side", completed: false }
        ]},
        Saturday: { title: "Dunk Session", focus: "Sport", exercises: [
          { name: "Max Approach Jumps", sets: "10 reps", completed: false },
          { name: "Penultimate Step Iso", sets: "3x10s", completed: false }
        ]},
        Sunday: { title: "Rest", focus: "Recovery", exercises: [
          { name: "Meal Prep", sets: "Weekly", completed: false },
          { name: "Sleep", sets: "9+ Hours", completed: false }
        ]}
      }
    },
    2: {
      name: "Phase 2: Force & Power",
      weeks: "Weeks 5-8",
      focus: "Contrast Training & Strength",
      workouts: {
        Monday: { title: "Contrast Squat", focus: "Max Force", exercises: [
          { name: "Back Squat", sets: "4x4 @ 85%", completed: false },
          { name: "Vertical Jump (Immed. After)", sets: "4x3", completed: false },
          { name: "Depth Drops", sets: "3x5", completed: false }
        ]},
        Tuesday: { title: "Upper Hypertrophy", focus: "Mass", exercises: [
          { name: "Incline Bench", sets: "4x8", completed: false },
          { name: "DB Rows", sets: "4x10", completed: false },
          { name: "Iso-Lunge Holds", sets: "4x45s", completed: false }
        ]},
        Wednesday: { title: "Recovery", focus: "Mobility", exercises: [
          { name: "Pool Work", sets: "20 mins", completed: false },
          { name: "Hip Flow", sets: "15 mins", completed: false }
        ]},
        Thursday: { title: "Speed Power", focus: "Velocity", exercises: [
          { name: "Hang Clean", sets: "4x3", completed: false },
          { name: "Flying 20s", sets: "4 reps", completed: false },
          { name: "Nordic Curls", sets: "3x5", completed: false }
        ]},
        Friday: { title: "Upper & Plyo", focus: "Elasticity", exercises: [
          { name: "Weighted Dips", sets: "3x8", completed: false },
          { name: "Depth Jumps", sets: "3x4", completed: false },
          { name: "Lateral Bounds", sets: "3x6/side", completed: false }
        ]},
        Saturday: { title: "Dunk Session", focus: "Max Touch", exercises: [
          { name: "Lob Dunks", sets: "10-15 reps", completed: false }
        ]},
        Sunday: { title: "Rest", focus: "Sleep", exercises: [{ name: "Sleep", sets: "10 hrs", completed: false }]}
      }
    },
    3: {
      name: "Phase 3: Peaking",
      weeks: "Weeks 9-12",
      focus: "Max Speed & Dunking",
      workouts: {
        Monday: { title: "Max Power", focus: "Neural Drive", exercises: [
          { name: "Quarter Squat", sets: "3x3 @ 90%", completed: false },
          { name: "Max Vertical Jump", sets: "5x1", completed: false }
        ]},
        Tuesday: { title: "Upper Maintenance", focus: "Tone", exercises: [
          { name: "Push Ups (Explosive)", sets: "3x10", completed: false },
          { name: "Chin Ups", sets: "3x8", completed: false }
        ]},
        Wednesday: { title: "Recovery", focus: "Mobility", exercises: [{ name: "Massage/Foam Roll", sets: "20 min", completed: false }]},
        Thursday: { title: "Overspeed", focus: "Twitch", exercises: [
          { name: "Assisted Jumps (Band)", sets: "4x4", completed: false },
          { name: "Flying 10s", sets: "3 reps (Max)", completed: false }
        ]},
        Friday: { title: "Priming", focus: "Activation", exercises: [
          { name: "Trap Bar Jump", sets: "4x3 (Light)", completed: false },
          { name: "Medicine Ball Slam", sets: "3x5", completed: false }
        ]},
        Saturday: { title: "Dunk Day", focus: "PR Attempt", exercises: [
          { name: "Dunk Attempts", sets: "Max Effort", completed: false }
        ]},
        Sunday: { title: "Rest", focus: "Sleep", exercises: [{ name: "Sleep", sets: "10 hrs", completed: false }]}
      }
    }
  }), []);

  // Initialize workouts
  const [workouts, setWorkouts] = useState(phases[1].workouts);

  // Update workouts when phase changes
  useEffect(() => {
    setWorkouts(phases[currentPhase].workouts);
  }, [currentPhase, phases]);

  // --- DATA: TECH LIBRARY (FULL DATABASE) ---
  const techLibrary = useMemo(() => ([
    // Phase 1
    { name: "Back Squat", cues: "Rip floor apart. Chest tall.", alerts: [{ type: "Hip", msg: "Don't force depth." }, { type: "Ankle", msg: "Use heel elevation." }] },
    { name: "Bulgarian Split Squat", cues: "Drop back knee straight down.", alerts: [{ type: "Ankle", msg: "Keep front heel glued down." }] },
    { name: "Weighted Planks", cues: "Squeeze glutes. Don't sag.", alerts: [] },
    { name: "Bench Press", cues: "Retract scapula. Drive feet.", alerts: [] },
    { name: "Weighted Pull-Ups", cues: "Full extension. Chest to bar.", alerts: [] },
    { name: "Iso-Lunge Holds", cues: "Knee hover 1 inch. HOLD.", alerts: [{ type: "Ankle", msg: "Drive big toe down. Build stiffness." }] },
    { name: "Tibialis Raises", cues: "Lean on wall. Toes to nose.", alerts: [{ type: "Ankle", msg: "Crucial for deceleration." }] },
    { name: "Single Leg RDL", cues: "Hinge at hip. Back leg long.", alerts: [{ type: "Hip", msg: "Square hips to floor." }] },
    { name: "Pogo Hops", cues: "Ankles only. Knees stiff.", alerts: [{ type: "Ankle", msg: "Fast contact. No heel touch." }] },
    { name: "Flying 10s", cues: "Build 20m. Max speed 10m.", alerts: [] },
    { name: "Trap Bar Deadlift", cues: "Hips down. Chest up.", alerts: [] },
    { name: "Seated Box Jumps", cues: "Sit, pause, EXPLODE up.", alerts: [{ type: "Hip", msg: "Use arms to drive momentum." }] },
    { name: "Lateral Lunges", cues: "Sink into one hip.", alerts: [{ type: "Hip", msg: "Great for opening impingement." }] },
    { name: "Max Approach Jumps", cues: "Full speed run up. Max intent.", alerts: [] },
    { name: "Penultimate Step Iso", cues: "Hold deep lunge position of jump.", alerts: [] },
    // Phase 2
    { name: "Vertical Jump", cues: "Max effort immediately after squat.", alerts: [] },
    { name: "Depth Drops", cues: "Step off. Stick landing (silent).", alerts: [{ type: "Ankle", msg: "Absorb through ball of foot." }] },
    { name: "Hang Clean", cues: "Jump with the bar. Catch high.", alerts: [{ type: "Hip", msg: "Full extension before catching." }] },
    { name: "Nordic Curls", cues: "Control the fall. Hamstrings only.", alerts: [] },
    { name: "Weighted Dips", cues: "Lean forward. Chest focus.", alerts: [] },
    { name: "Depth Jumps", cues: "Land and immediately rebound.", alerts: [{ type: "Ankle", msg: "Ground contact time < 0.2s." }] },
    { name: "Lateral Bounds", cues: "Skater jumps. Stick landing.", alerts: [] },
    { name: "Lob Dunks", cues: "Timing focus. Catch and finish.", alerts: [] },
    // Phase 3
    { name: "Quarter Squat", cues: "Heavy load. Jump range of motion.", alerts: [{ type: "Back", msg: "Brace core hard." }] },
    { name: "Max Vertical Jump", cues: "Testing day intensity.", alerts: [] },
    { name: "Push Ups (Explosive)", cues: "Push hard enough to leave ground.", alerts: [] },
    { name: "Assisted Jumps (Band)", cues: "Band pulls you up. Land soft.", alerts: [{ type: "Ankle", msg: "Focus on speed off ground." }] },
    { name: "Trap Bar Jump", cues: "Light weight. Jump with bar.", alerts: [] },
    { name: "Medicine Ball Slam", cues: "Full extension to full flexion.", alerts: [] },
    { name: "Dunk Attempts", cues: "Game time. Be aggressive.", alerts: [] },
    // General
    { name: "10m Starts", cues: "Push back, not up. Low shin angle.", alerts: [] },
    { name: "Incline Bench", cues: "Upper chest focus.", alerts: [] },
    { name: "DB Rows", cues: "Pull to hip pocket.", alerts: [] },
    { name: "Farmer Carries", cues: "Walk tall. Shoulders back.", alerts: [] },
  ]), []);

  // --- DATA: RECIPES ---
  const [recipes, setRecipes] = useState([
    { id: 1, type: "Breakfast", title: "The Power Omelet", calories: "600", ingredients: ["3 Eggs", "1/2 Cup Cheese", "Spinach", "2 Toast slices", "1 Avocado"] },
    { id: 2, type: "Breakfast", title: "Pro-Oats Bowl", calories: "550", ingredients: ["1 Cup Oats", "1 Scoop Whey", "Berries", "1 Tbsp Peanut Butter"] },
    { id: 3, type: "Lunch", title: "Chicken & Rice Load", calories: "750", ingredients: ["8oz Chicken Thigh", "2 Cups White Rice", "Olive Oil Drizzle", "Broccoli"] },
    { id: 4, type: "Lunch", title: "Beef Pasta", calories: "800", ingredients: ["8oz Ground Beef", "2 Cups Pasta", "Marinara Sauce", "Parmesan"] },
    { id: 5, type: "Dinner", title: "Steak & Potato", calories: "700", ingredients: ["8oz Steak", "1 Large Potato", "Asparagus", "Butter"] },
    { id: 6, type: "Dinner", title: "Salmon Fuel", calories: "650", ingredients: ["8oz Salmon", "Quinoa/Rice", "Avocado", "Soy Sauce"] },
    { id: 7, type: "Shake", title: "1,000 Calorie Shake", calories: "1130", ingredients: ["2 Cups Whole Milk", "1 Cup Oats (Blended)", "2 Tbsp PB", "1 Banana", "1 Scoop Whey", "1 Tbsp Olive Oil"] },
    { id: 8, type: "Shake", title: "Tendon Shot", calories: "100", ingredients: ["15g Collagen", "500mg Vitamin C (OJ)"] },
  ]);

  const handleAddRecipe = (newRecipeData) => {
    if (!newRecipeData.title) return;
    const newRec = {
      id: recipes.length + 1,
      type: newRecipeData.type,
      title: newRecipeData.title,
      calories: newRecipeData.calories,
      ingredients: newRecipeData.ingredients.split(',').map(i => i.trim())
    };
    setRecipes([...recipes, newRec]);
    setShowAddRecipe(false);
  };

  const toggleExercise = (day, index) => {
    const newWorkouts = {...workouts};
    newWorkouts[day].exercises[index].completed = !newWorkouts[day].exercises[index].completed;
    setWorkouts(newWorkouts);
  };

  const toggleFuelItem = (key) => {
    setFuelLog(prev => ({
      ...prev,
      items: { ...prev.items, [key]: !prev.items[key] }
    }));
  };

  const adjustWater = (amount) => {
    setFuelLog(prev => ({ ...prev, water: Math.max(0, prev.water + amount) }));
  };

  // --- VIEWS ---

  const DashboardView = () => (
    <div className="h-full overflow-y-auto p-4 space-y-6 pb-24 animate-in fade-in slide-in-from-bottom-4 duration-500">
      {/* Stats Cards */}
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-neutral-800/50 p-4 rounded-xl border border-neutral-700/50 relative overflow-hidden">
          <div className="absolute top-0 right-0 p-2 opacity-10"><Activity className="w-12 h-12 text-red-500" /></div>
          <div className="text-neutral-400 text-xs font-bold tracking-widest mb-1">WEIGHT</div>
          <div className="text-2xl font-black text-white flex items-end gap-1">
            {stats.weight} <span className="text-sm font-medium text-neutral-500 mb-1">lbs</span>
          </div>
          <div className="w-full bg-neutral-700 h-1 mt-2 rounded-full">
            <div className="bg-red-600 h-1 rounded-full" style={{ width: `${(stats.weight/150)*100}%` }}></div>
          </div>
        </div>
        
        <div className="bg-neutral-800/50 p-4 rounded-xl border border-neutral-700/50 relative overflow-hidden">
           <div className="absolute top-0 right-0 p-2 opacity-10"><Zap className="w-12 h-12 text-yellow-500" /></div>
          <div className="text-neutral-400 text-xs font-bold tracking-widest mb-1">VERT</div>
          <div className="text-2xl font-black text-white flex items-end gap-1">
            {stats.vertical} <span className="text-sm font-medium text-neutral-500 mb-1">in</span>
          </div>
          <div className="mt-2 text-[10px] text-green-400 font-medium">{stats.speed}s 40yd</div>
        </div>
      </div>

      {/* Injury Alert */}
      <div className="bg-red-900/10 border border-red-900/30 p-4 rounded-xl flex items-start space-x-3">
        <AlertTriangle className="text-red-500 w-5 h-5 mt-0.5 flex-shrink-0" />
        <div>
          <h3 className="text-red-500 font-bold text-sm mb-1 tracking-wide">SYSTEM ALERTS ACTIVE</h3>
          <p className="text-neutral-400 text-xs leading-relaxed"><span className="text-neutral-200 font-medium">Ankle:</span> {stats.injuries.ankle}</p>
          <p className="text-neutral-400 text-xs leading-relaxed mt-1"><span className="text-neutral-200 font-medium">Hip:</span> {stats.injuries.hip}</p>
        </div>
      </div>

      {/* Schedule / Timeline */}
      <div>
        <h2 className="text-neutral-200 font-bold text-lg mb-3 flex items-center">
          <Clock className="w-5 h-5 mr-2 text-blue-400" /> Driver's Schedule
        </h2>
        <div className="bg-neutral-900 rounded-xl border border-neutral-800 p-2 space-y-3">
          
          {/* Morning Block */}
          <div className="pl-2 border-l-2 border-yellow-500 ml-2">
            <div className="text-[10px] text-yellow-500 font-bold uppercase mb-1">07:00 - Morning Protocol</div>
            <div onClick={() => toggleFuelItem('morningHydration')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.morningHydration ? 'opacity-50' : ''}`}>
               {fuelLog.items.morningHydration ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">16oz Water</span>
            </div>
            <div onClick={() => toggleFuelItem('creatine')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.creatine ? 'opacity-50' : ''}`}>
               {fuelLog.items.creatine ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">5g Creatine Monohydrate</span>
            </div>
            <div onClick={() => toggleFuelItem('breakfast')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.breakfast ? 'opacity-50' : ''}`}>
               {fuelLog.items.breakfast ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">High Protein Breakfast</span>
            </div>
          </div>

          {/* Training Block */}
          <div className="pl-2 border-l-2 border-red-500 ml-2">
            <div className="text-[10px] text-red-500 font-bold uppercase mb-1">Pre-Workout (14:00)</div>
            <div onClick={() => toggleFuelItem('tendonShot')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.tendonShot ? 'opacity-50' : ''}`}>
               {fuelLog.items.tendonShot ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">Tendon Shot (Collagen + Vit C)</span>
            </div>
            <div onClick={() => toggleFuelItem('preWorkoutCarb')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.preWorkoutCarb ? 'opacity-50' : ''}`}>
               {fuelLog.items.preWorkoutCarb ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">Fast Carb (Fruit/Candy)</span>
            </div>
          </div>

          {/* Post Block */}
          <div className="pl-2 border-l-2 border-green-500 ml-2">
            <div className="text-[10px] text-green-500 font-bold uppercase mb-1">Post-Workout (17:00)</div>
            <div onClick={() => toggleFuelItem('postWorkoutShake')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.postWorkoutShake ? 'opacity-50' : ''}`}>
               {fuelLog.items.postWorkoutShake ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">Whey Protein Shake</span>
            </div>
             <div onClick={() => toggleFuelItem('postWorkoutMeal')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.postWorkoutMeal ? 'opacity-50' : ''}`}>
               {fuelLog.items.postWorkoutMeal ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">High Carb Meal (Chicken/Rice)</span>
            </div>
          </div>

          {/* Night Block */}
          <div className="pl-2 border-l-2 border-purple-500 ml-2">
            <div className="text-[10px] text-purple-500 font-bold uppercase mb-1">21:00 - Night Cap</div>
            <div onClick={() => toggleFuelItem('dinner')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.dinner ? 'opacity-50' : ''}`}>
               {fuelLog.items.dinner ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">Dinner (Steak/Potato)</span>
            </div>
            <div onClick={() => toggleFuelItem('nightShake')} className={`flex items-center space-x-3 p-2 rounded hover:bg-neutral-800 transition-colors cursor-pointer ${fuelLog.items.nightShake ? 'opacity-50' : ''}`}>
               {fuelLog.items.nightShake ? <CheckCircle2 className="w-4 h-4 text-green-500" /> : <Circle className="w-4 h-4 text-neutral-600" />}
               <span className="text-sm text-neutral-300">1,000 Calorie Shake</span>
            </div>
          </div>

        </div>
      </div>
    </div>
  );

  const TrainingView = () => (
    <div className="h-full flex flex-col pb-24 animate-in fade-in zoom-in-95 duration-300">
      {/* Phase Selector */}
      <div className="px-4 pt-4 pb-2">
        <div className="flex bg-neutral-800 rounded-lg p-1">
          {[1, 2, 3].map(p => (
            <button 
              key={p} 
              onClick={() => setCurrentPhase(p)}
              className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${currentPhase === p ? 'bg-neutral-700 text-white shadow' : 'text-neutral-500'}`}
            >
              PHASE {p}
            </button>
          ))}
        </div>
        <div className="mt-2 text-center">
          <span className="text-xs text-red-500 font-bold tracking-widest uppercase block">{phases[currentPhase].weeks}</span>
          <span className="text-[10px] text-neutral-400">{phases[currentPhase].focus}</span>
        </div>
      </div>

      {/* Day Selector */}
      <div className="overflow-x-auto whitespace-nowrap p-4 border-b border-neutral-800 bg-neutral-900/50 backdrop-blur pb-2">
        <div className="flex space-x-3">
          {Object.keys(workouts).map(day => (
            <button
              key={day}
              onClick={() => setSelectedDay(day)}
              className={`px-5 py-2 rounded-full text-xs font-bold tracking-wide transition-all ${
                selectedDay === day 
                ? 'bg-red-600 text-white shadow-lg shadow-red-900/20' 
                : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
              }`}
            >
              {day.substring(0, 3).toUpperCase()}
            </button>
          ))}
        </div>
      </div>

      {/* Workout Card */}
      <div className="flex-1 overflow-y-auto p-4">
        <div className="mb-6">
          <div className="flex justify-between items-end mb-2">
             <h2 className="text-2xl font-black text-white italic uppercase">{selectedDay}</h2>
             <span className="text-xs font-bold text-red-500 border border-red-900/30 px-2 py-1 rounded bg-red-900/10 uppercase">
               {workouts[selectedDay].focus}
             </span>
          </div>
          <p className="text-neutral-400 text-sm mb-4 font-medium">{workouts[selectedDay].title}</p>
          
          <div className="space-y-3">
            {workouts[selectedDay].exercises.map((ex, idx) => (
              <div 
                key={idx}
                onClick={() => toggleExercise(selectedDay, idx)}
                className={`group p-4 rounded-xl border transition-all cursor-pointer flex items-center justify-between ${
                  ex.completed 
                  ? 'bg-green-900/10 border-green-900/30 opacity-60' 
                  : 'bg-neutral-800 border-neutral-700 hover:border-neutral-500'
                }`}
              >
                <div>
                  <div className={`font-bold text-sm ${ex.completed ? 'text-green-400 line-through' : 'text-white'}`}>
                    {ex.name}
                  </div>
                  <div className="text-xs text-neutral-400 mt-1 font-mono">{ex.sets}</div>
                </div>
                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${
                  ex.completed ? 'border-green-500 bg-green-500' : 'border-neutral-600 group-hover:border-neutral-400'
                }`}>
                  {ex.completed && <CheckCircle2 className="w-4 h-4 text-black" />}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  const FuelView = () => (
    <div className="p-4 space-y-6 pb-24 overflow-y-auto h-full animate-in fade-in slide-in-from-right-4 duration-500">
      
      {/* Water Tracker */}
      <div className="bg-blue-900/20 border border-blue-900/50 p-4 rounded-xl flex items-center justify-between">
        <div className="flex items-center space-x-3">
          <div className="p-3 bg-blue-500/20 rounded-full"><Droplets className="w-6 h-6 text-blue-400" /></div>
          <div>
            <div className="text-xs text-blue-300 font-bold uppercase tracking-widest">Hydration</div>
            <div className="text-xl font-black text-white">{fuelLog.water} <span className="text-sm font-medium opacity-50">/ 8 bottles</span></div>
          </div>
        </div>
        <div className="flex items-center space-x-2">
           <button onClick={() => adjustWater(-1)} className="w-8 h-8 rounded-full bg-neutral-800 text-white flex items-center justify-center font-bold hover:bg-neutral-700">-</button>
           <button onClick={() => adjustWater(1)} className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold hover:bg-blue-500">+</button>
        </div>
      </div>

      <div>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-white font-bold flex items-center"><Utensils className="w-4 h-4 mr-2" /> Recipe Book</h3>
          <button onClick={() => setShowAddRecipe(true)} className="bg-neutral-800 p-2 rounded-full hover:bg-neutral-700 transition-colors">
            <Plus className="w-4 h-4 text-white" />
          </button>
        </div>

        {/* Filters */}
        <div className="flex gap-2 overflow-x-auto pb-4">
          {['All', 'Breakfast', 'Lunch', 'Dinner', 'Shake'].map(f => (
            <button 
              key={f}
              onClick={() => setActiveRecipeFilter(f)}
              className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border ${activeRecipeFilter === f ? 'bg-white text-black border-white' : 'bg-transparent text-neutral-500 border-neutral-700'}`}
            >
              {f}
            </button>
          ))}
        </div>

        <div className="space-y-4">
          {recipes.filter(r => activeRecipeFilter === 'All' || r.type === activeRecipeFilter).map((recipe, idx) => (
            <div key={idx} className="bg-neutral-800 rounded-xl overflow-hidden border border-neutral-700">
              <div className="bg-neutral-700/30 p-3 border-b border-neutral-700 flex justify-between items-center">
                <span className="font-bold text-white text-sm">{recipe.title}</span>
                <div className="flex items-center space-x-2">
                   <span className="text-[10px] font-mono text-neutral-400">{recipe.calories} kcal</span>
                   <Flame className="w-4 h-4 text-orange-500" />
                </div>
              </div>
              <div className="p-4">
                <ul className="space-y-1">
                  {recipe.ingredients.map((ing, i) => (
                    <li key={i} className="text-xs text-neutral-300 flex items-center">
                      <div className="w-1 h-1 bg-red-500 rounded-full mr-2"></div>
                      {ing}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );

  const TechView = () => {
    // 1. Get exercises for the CURRENT PHASE
    const currentPhaseWorkouts = phases[currentPhase].workouts;
    
    // 2. Filter exercises for the SELECTED DAY
    const dayExercises = currentPhaseWorkouts[selectedDay]?.exercises || [];
    
    // 3. Match them to the Tech Library Database
    // We create a list of Tech Cards that match the exercise names in that day's workout
    const relevantTech = dayExercises.map(ex => {
      return techLibrary.find(t => t.name === ex.name) || { name: ex.name, cues: "Standard execution.", alerts: [] };
    });

    return (
      <div className="p-4 h-full flex flex-col pb-24 animate-in fade-in duration-500">
        <div className="mb-4">
          <h2 className="text-white font-bold text-xl mb-1">Tech Library</h2>
          <p className="text-neutral-400 text-xs">Syncing with <span className="text-red-500 font-bold">PHASE {currentPhase}</span></p>
        </div>

        {/* Phase Selector Link (Visual Only) */}
        <div className="flex bg-neutral-800 rounded-lg p-1 mb-4">
          {[1, 2, 3].map(p => (
             <button 
             key={p} 
             onClick={() => setCurrentPhase(p)}
             className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${currentPhase === p ? 'bg-neutral-700 text-white shadow' : 'text-neutral-500'}`}
           >
             PHASE {p}
           </button>
          ))}
        </div>

        {/* Day Selector (Syncs with Training) */}
        <div className="overflow-x-auto whitespace-nowrap border-b border-neutral-800 pb-2 mb-4">
          <div className="flex space-x-2">
            {Object.keys(currentPhaseWorkouts).map(day => (
              <button
                key={day}
                onClick={() => setSelectedDay(day)}
                className={`px-4 py-1.5 rounded-full text-[10px] font-bold tracking-wide transition-all ${
                  selectedDay === day 
                  ? 'bg-red-600 text-white' 
                  : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
                }`}
              >
                {day.substring(0, 3).toUpperCase()}
              </button>
            ))}
          </div>
        </div>
        
        <div className="space-y-2 overflow-y-auto flex-1">
          {relevantTech.length > 0 ? (
            relevantTech.map((tech, idx) => (
              <button
                key={idx}
                onClick={() => setSelectedTech(tech)}
                className="w-full text-left bg-neutral-800 p-4 rounded-xl border border-neutral-700 hover:bg-neutral-750 hover:border-red-900/50 transition-all flex justify-between items-center group"
              >
                <div>
                  <div className="font-bold text-white text-sm group-hover:text-red-400 transition-colors">{tech.name}</div>
                  <div className="flex gap-2 mt-2">
                      <span className="text-[10px] bg-neutral-900 text-neutral-400 px-2 py-1 rounded border border-neutral-700">
                        {selectedDay}
                      </span>
                      {tech.alerts && tech.alerts.length > 0 && (
                        <span className="text-[10px] bg-red-900/20 text-red-400 px-2 py-1 rounded border border-red-900/50 flex items-center">
                          <AlertTriangle className="w-3 h-3 mr-1"/> Injury Focus
                        </span>
                      )}
                  </div>
                </div>
                <ChevronRight className="w-5 h-5 text-neutral-600 group-hover:text-red-500" />
              </button>
            ))
          ) : (
            <div className="text-center py-10 text-neutral-500 text-sm">No tech cards for this rest day.</div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="flex flex-col h-screen bg-[#121212] text-white font-sans overflow-hidden selection:bg-red-500/30">
      {/* Header with Settings Trigger */}
      <div className="bg-neutral-900 p-4 sticky top-0 z-20 border-b border-red-900/30 backdrop-blur-md bg-opacity-90">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <Activity className="text-red-600 w-6 h-6" />
            <span className="font-bold text-white tracking-wider text-lg">COACH<span className="text-red-600">OS</span></span>
          </div>
          <button onClick={() => setShowProfile(true)} className="flex items-center space-x-3 group">
            <div className="text-right hidden sm:block">
              <div className="text-[10px] text-neutral-400 uppercase tracking-widest">Operator</div>
              <div className="text-xs font-bold text-white group-hover:text-red-400 transition-colors">TONIO GENETICS</div>
            </div>
            <div className="w-8 h-8 bg-neutral-800 rounded-full border border-red-600/50 flex items-center justify-center group-hover:border-red-500 transition-colors relative">
               <User className="w-4 h-4 text-neutral-300" />
               <div className="absolute -bottom-1 -right-1 bg-red-600 rounded-full p-0.5"><Settings className="w-2 h-2 text-white"/></div>
            </div>
          </button>
        </div>
      </div>
      
      <main className="flex-1 overflow-hidden relative">
        {activeTab === 'dashboard' && <DashboardView />}
        {activeTab === 'training' && <TrainingView />}
        {activeTab === 'fuel' && <FuelView />}
        {activeTab === 'tech' && <TechView />}
      </main>

      {/* Nav Bar */}
      <div className="fixed bottom-0 left-0 right-0 bg-neutral-900 border-t border-neutral-800 pb-safe pt-2 px-6 flex justify-between items-center z-50 h-20">
        {[
          { id: 'dashboard', icon: LayoutDashboard, label: 'Dash' },
          { id: 'training', icon: Dumbbell, label: 'Train' },
          { id: 'fuel', icon: Utensils, label: 'Fuel' },
          { id: 'tech', icon: Zap, label: 'Tech' }
        ].map((btn) => (
          <button 
            key={btn.id}
            onClick={() => setActiveTab(btn.id)}
            className={`flex flex-col items-center space-y-1 w-16 ${activeTab === btn.id ? 'text-red-500' : 'text-neutral-500 hover:text-neutral-300'}`}
          >
            <btn.icon className={`w-6 h-6 ${activeTab === btn.id ? 'stroke-[2.5px]' : 'stroke-2'}`} />
            <span className="text-[10px] font-medium tracking-wide">{btn.label}</span>
          </button>
        ))}
      </div>

      <ProfileModal show={showProfile} onClose={() => setShowProfile(false)} stats={stats} setStats={setStats} />
      <AddRecipeModal show={showAddRecipe} onClose={() => setShowAddRecipe(false)} onAdd={handleAddRecipe} />
      <TechDetailModal tech={selectedTech} onClose={() => setSelectedTech(null)} />
    </div>
  );
};

export default CoachOS;



